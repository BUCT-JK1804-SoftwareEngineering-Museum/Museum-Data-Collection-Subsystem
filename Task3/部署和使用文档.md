[TOC]

# 部署和使用文档

## 前言

本文档主要介绍MySQL的安装配置，以及Scrapy如何在远程服务器部署

## 软件环境：

- 数据库：MySQL8.0
- 开发工具包：Python3.8
- 开发环境：Pycharm



## MySQL的安装

### 安装MySQL8.0

使用最新的包管理器安装MySQL

```shell
sudo dnf install @mysql
```

### 开启启动

安装完成后，运行以下命令来启动MySQL服务并使它在启动时自动启动：

```shell
sudo systemctl enable --now mysqld
```

要检查MySQL服务器是否正在运行，请输入：

```shell
sudo systemctl status mysqld
```

### 添加密码及安全设置

运行mysql_secure_installation脚本，该脚本执行一些与安全性相关的操作并设置MySQL根密码：

```shell
sudo mysql_secure_installation
```

其中等级策略填0

```shell
Please enter 0 = LOW, 1 = MEDIUM and 2 = STRONG: 0
```

不允许root远程登录选n

```shell
Disallow root login remotely? (Press y|Y for Yes, any other key for No) : n
```

### 配置远程登录

本机登录

```shell
mysql -uroot -p<上面步骤中设置的密码>
```

回车后变成 mysql>

接着执行以下mysql语句

```shell
use mysql;
update user set host='%' where user='root';
flush privileges;
```

设置完成后退出mysql（exit）,开启防火墙并打开3306端口：

确认防火墙状态：

```shell
systemctl status firewalld
```

如果dead，则为关闭

打开防火墙：

```shell
systemctl start firewalld
```

接着执行以下语句：

```shell
sudo firewall-cmd --add-port=3306/tcp --permanent
sudo firewall-cmd --reload
```

关闭防火墙

```shell
systemctl stop firewalld.service
```



## Scrapy部署

### 本机下载

Windows下不建议直接使用`pip install scrapy-client`, 这样会没法直接使用scrapyd-deploy

在[github](https://github.com/scrapy/scrapyd-client)上下载安装解压后，进入解压目录，执行

```
python setup.py install
```

若之前已经安装，卸载

```shell
pip list
pip uninstall scrapyd-client
```

### 安装python3

自行去网上寻找教程，比较简单

### 远程部署

安装相关的库

```shell
# 安装 scrapy，scrapyd，scrapyd-client
pip3 install scrapy
pip3 install scrapyd
pip3 install scrapyd-client

# 更新pip
pip3 install --upgrade pip

# 安装项目需要的库
pip install requests
```

使得外网可以访问服务器IP，修改以下文件

```shell
# 查找default_scrapyd.conf路径
find / -name default_scrapyd.conf

#修改default_scrapyd.conf文件，使得外网ip可以访问
vi /usr/local/lib/python3.6/site-packages/scrapyd/default_scrapyd.conf
```

将文件下里的bind_address修改为0.0.0.0

在阿里云控制台，进入安全组加入6800端口

用` '/usr/local/bin/scrapyd'  `启动scrapyd,加上nohup &则在后台启动运行

```shell
# 查找目录
whereis scrapyd
# 启动
'/usr/local/bin/scrapyd'
# 后台启动运行
nohup '/usr/local/bin/scrapyd' &
```

scrapyd启用成功，最后一行会有

```shell
2021-04-06T09:34:35+0800 [Launcher] Scrapyd 1.2.1 started: max_proc=4, runner='scrapyd.runner'
```

后台运行，会有

```shell
[root@iZ2ze4wxczo5rze28eywmjZ ~]# nohup '/usr/local/bin/scrapyd' &
[1] 32053
[root@iZ2ze4wxczo5rze28eywmjZ ~]# nohup: ignoring input and appending output to 'nohup.out'
```

之后通过服务器外网IP:6800,可以看到以下页面

![jj](image\a.png)

如果没有看到界面关闭防火墙

```sh
systemctl stop firewalld.service
```

或者单独放行6800端口

```shell
firewall-cmd --zone=public --add-port=6800/tcp --permanent
```

